# Контекст проекта: Веб-сайт автомобильных объявлений

## Общая информация
- **Название проекта**: avtozakaz74Site
- **Тип проекта**: Веб-сайт с автомобильными объявлениями
- **Директория**: `C:\Users\parap\PycharmProjects\avtozakaz74Site`
- **Дата создания контекста**: 2026-01-25

## Описание
Веб-сайт для размещения и просмотра автомобильных объявлений.

## Статус
Фронтенд разработан, адаптирован под API che168, упакован в Docker.

**В разработке**: Backend прокси-сервер для сокрытия API токена.

**Готово к деплою**: Текущая версия с открытым токеном (dev/staging).

## Технологический стек
### Backend API:
- **Источник данных**: API che168.com (https://api-centr.ru/che168/)
- **Спецификация**: OpenAPI 3.1.0 (сохранена в api_specification.json)

### Основные возможности API:
1. **Поиск автомобилей** (POST /che168/search_car)
   - Фильтры: бренд, модель, цена, год, пробег, мощность, объем двигателя, тип топлива, город
   - Пагинация и сортировка
   - Автоматический расчет цен в RUB с учетом таможенных сборов

2. **Получение доступных фильтров** (POST /che168/getAvailableFilters)
   - Динамическое построение UI фильтров
   - Поддержка поиска по текстовым полям

3. **Детальная информация об авто** (POST /che168/get_car_info)
   - Подробные данные по ID автомобиля

### Данные автомобилей:
- ID автомобиля (infoid)
- Бренд, модель, модификация
- Цена в CNY и RUB (с таможенными сборами)
- Год выпуска, пробег
- Тип топлива, объем двигателя, мощность
- Город, дилер
- Изображение
- Актуальные курсы валют (CNY, EUR к RUB)

### Аутентификация:
- API Key в заголовке Authorization
- Тарифная система доступа
- Получение токена: https://t.me/api_centr_regbot
- **Токен проекта**: che168-Onh9OZEJchYMZgdXy (не использовать в открытом коде)

## Структура проекта
```
avtozakaz74Site/
├── frontend/                  # React фронтенд приложение
│   ├── src/
│   │   ├── components/       # React компоненты
│   │   │   ├── CarCard.jsx             # Карточка автомобиля
│   │   │   ├── Filters.jsx             # Фильтры поиска
│   │   │   ├── FilterPresets.jsx       # Пресеты фильтров
│   │   │   ├── SearchableSelect.jsx    # Select с поиском (для модели)
│   │   │   ├── MultiSearchableSelect.jsx # Мультивыбор с поиском (для марок)
│   │   │   ├── NumericInputWithOptions.jsx # Числовой input с dropdown
│   │   │   ├── SortSelector.jsx        # Сортировка результатов
│   │   │   ├── Pagination.jsx          # Пагинация
│   │   │   └── CarDetailModal.jsx      # Модальное окно с деталями
│   │   ├── lib/             # Утилиты
│   │   │   ├── api.js              # API клиент для che168
│   │   │   ├── currency.js         # Расчёт полной стоимости с налогами и сборами
│   │   │   ├── fuelTypes.js        # Маппинг типов топлива
│   │   │   └── colorTranslations.js # Перевод цветов с английского на русский
│   │   ├── App.jsx          # Главный компонент
│   │   ├── main.jsx         # Точка входа
│   │   └── index.css        # Стили
│   ├── public/              # Статические файлы
│   │   ├── logo_pic.png        # Логотип (иконка)
│   │   ├── logo_text.png       # Логотип (текст)
│   │   └── background.jpg      # Фоновое изображение hero секции
│   ├── brandname.json       # Справочник марок автомобилей
│   ├── color_translations.json # Справочник цветов (китайский → английский)
│   ├── index.html           # HTML шаблон
│   ├── package.json         # Зависимости npm
│   ├── vite.config.js       # Конфигурация Vite
│   ├── tailwind.config.js   # Конфигурация Tailwind CSS
│   ├── postcss.config.js    # Конфигурация PostCSS
│   ├── Dockerfile           # Docker образ frontend
│   ├── nginx.conf           # Nginx конфигурация
│   └── .dockerignore        # Исключения для Docker
├── docker-compose.yml       # Docker Compose конфигурация
├── .dockerignore            # Исключения для Docker
├── api_specification.json   # OpenAPI спецификация
├── PROJECT_CONTEXT.md       # Контекст проекта
├── README.md                # Основная документация
└── DEPLOYMENT.md            # Инструкция по деплою
```

## Технологический стек фронтенда
- **Framework**: React 18.3.1
- **Build Tool**: Vite 6.0.3
- **Styling**: Tailwind CSS 3.4.17
- **State Management**: React Hooks (useState, useEffect)
- **HTTP Client**: Fetch API

## Реализованный функционал
### Основные возможности:
1. **Поиск автомобилей** с фильтрацией по:
   - Марка (brandname) - множественный выбор с поиском (из локального brandname.json)
   - Модель (seriesname) - searchable select с поиском, загрузка по выбранным маркам
   - Год выпуска (year_from/year_to) - числовой ввод с предустановками 2005-2026
   - Цена в рублях (total_price_rub_min/max) - с предустановками и форматированием
   - Пробег (mileage_from/to) - с предустановками и форматированием
   - Тип топлива (fuel_type) - упрощенные категории (Бензин, Дизель, Гибрид, Электричество)
   - Объем двигателя в литрах (engine_volume_from/to) - автоконвертация в мл для API
   - Мощность в л.с. (power_from/to) - автоконвертация в кВт для API

2. **Пагинация результатов**
   - Настраиваемый размер страницы (по умолчанию 10)
   - Навигация по страницам

3. **Отображение информации**
   - Карточки автомобилей с фото
   - Цены с учетом всех сборов
   - Актуальные курсы валют из API

4. **Детальная информация**
   - Модальное окно с полной информацией
   - Галерея фотографий (из get_car_info API)
   - Детальный расчёт стоимости с разбивкой по статьям
   - Название автомобиля (carname)
   - Цвет автомобиля (перевод с английского на русский)
   - Дата публикации объявления (vehicle_info.publicdate: "today" → "Сегодня", или DD.MM.YYYY)
   - Технические характеристики (8 полей):
     * Пробег
     * КПП (тип коробки передач)
     * Дата первой регистрации (DD.MM.YYYY)
     * Тип топлива (с детальным маппингом гибридов)
     * Двигатель
     * Город
     * Привод (technical_specs.drivingmode)
     * Расход топлива по WLTC (technical_specs.wltc_fuelconsumption)
   - Примечания продавца (history_condition.remark) - отдельный блок с жёлтым фоном

5. **Сортировка результатов**
   - По актуальности (infoid)
   - По цене (total_price_rub)
   - По году (firstregyear)
   - По пробегу (mileage)
   - Переключение ASC/DESC при повторном клике

6. **Пресеты фильтров**
   - Проходные по годам (3-5 лет)
   - Проходные по мощности (до 160 л.с.)
   - Немецкие авто (Audi, BMW, Mercedes-Benz, VW, Porsche, Opel, Mini)
   - Японские авто (Toyota, Honda, Nissan, Mazda, Lexus, Subaru, Mitsubishi, Suzuki, Infiniti, Acura)

### API интеграция:
- Прямое подключение к https://api-centr.ru/che168/
- Автоматическая трансформация фильтров под формат API:
  * Объем двигателя: литры → миллилитры (умножение на 1000)
  * Мощность: лошадиные силы → киловатты (деление на 1.36)
  * Текстовые фильтры в массивы
  * Диапазоны в формат [min, max]
- Динамическая загрузка списков марок и моделей через /getAvailableFilters
- Обработка ответов с курсами валют (CNY и EUR)
- Обработка ошибок и состояний загрузки

### Архитектура работы с данными:
**Разделение источников данных:**
- **search_car API** → финансовые данные (price_cny, import_duty, customs_fee_rub, recycling_fee_rub)
- **get_car_info API** → детальная информация (фото, характеристики, цвет)

**Процесс отображения детальной карточки:**
1. Пользователь выполняет поиск → получаем список автомобилей из search_car
2. При клике на карточку → сохраняем полный объект car (с финансовыми данными)
3. В модальном окне:
   - Загружаем детальную информацию из get_car_info
   - Используем финансовые данные из сохранённого объекта car
   - Объединяем оба источника для полного отображения

## Запуск проекта
### Установка зависимостей:
```bash
cd frontend
npm install
```

### Разработка:
```bash
npm run dev
```
Приложение будет доступно на http://localhost:5173

### Сборка для продакшена:
```bash
npm run build
```
Собранные файлы будут в папке `frontend/dist/`

### Предпросмотр продакшен сборки:
```bash
npm run preview
```

## Дизайн и UX
### Современный дизайн (тренды 2025):
- Градиенты и backdrop-blur эффекты
- Улучшенные тени и скругления
- Микроанимации и плавные переходы
- Воздушная компоновка с увеличенными отступами
- Логотип АвтоЗаказ3 74 (h-20) с drop-shadow

### Контакты компании:
- +7 902 614-25-03 (Дмитрий)
- +7 919 302-89-13 (Максим)
- +7 951 450-22-25 (Максим)
- Telegram: https://t.me/avtozakaz74

### UX улучшения фильтров:
- **SearchableSelect**: поиск по марке/модели с текстовым вводом, без стрелок раскрытия
- **NumericInputWithOptions**: 
  * Гибридный ввод - можно вводить вручную или выбрать из списка
  * Убраны стрелки вверх/вниз (appearance: textfield)
  * Dropdown с прокруткой (max 210px height)
  * Форматирование с разрядностью (1 000 000 вместо дублирования)
- Все поля высотой 42px для единообразия
- Предустановленные значения для быстрого выбора:
  * Цена: 1-3 млн (от), 1.5-4 млн (до)
  * Год: 2005-2026
  * Пробег: 0-200k с шагами 10k/20k
  * Объем: 0.5-4.0L с шагом 0.1L до 2L, затем 0.5L
  * Мощность: 70-310 л.с. с переменным шагом

## Планируемые улучшения

### Backend Прокси-сервер (в разработке)
**Цель**: Скрыть API токен che168 от клиентского кода

**Архитектура**:
```
Браузер → Frontend (nginx) → Backend Proxy → API che168 (с токеном)
```

**Технологии на рассмотрении**:
- Node.js + Express/Fastify
- Python + FastAPI
- Serverless (Cloudflare Workers / Vercel Functions)

**Функционал прокси**:
- Приём запросов от frontend без токена
- Добавление токена на сервере
- Проксирование к che168 API
- Rate limiting для защиты от злоупотреблений
- Логирование запросов
- Кэширование частых запросов (опционально)

**Безопасность**:
- Токен хранится только в переменных окружения на сервере
- CORS настройки для ограничения доступа
- Валидация входящих запросов

## Деплой на VPS
Проект готов к развертыванию через Docker:
- **Docker Compose**: `docker compose up -d --build`
- **Nginx**: проксирование /api/ на https://api-centr.ru/che168/
- **Порт**: 80 (HTTP)
- **Подробнее**: см. DEPLOYMENT.md
- ⚠️ **Текущая версия**: Токен виден в клиентском коде (требуется backend прокси)

## Расчёт стоимости автомобиля

### Формула полной стоимости в России:
```
1. Цена автомобиля в Китае = price_cny × курс CNY → RUB
2. Единая ставка налога = import_duty (EUR) × курс EUR → RUB
3. Таможенное оформление = customs_fee_rub
4. Утилизационный сбор = recycling_fee_rub
5. Услуги подбора и доставки по Китаю = 15 000 CNY × курс CNY → RUB
6. Услуги таможенного брокера и лаборатория = 75 000 ₽
7. Комиссия Автозаказ74 = 150 000 ₽
──────────────────────────────────────────────────────────────
ПОЛНАЯ СТОИМОСТЬ В РОССИИ = сумма всех пунктов
```

### Важные моменты:
- **import_duty** приходит в ЕВРО и конвертируется в рубли
- **Курсы валют** (CNY и EUR) получаются из API search_car в поле `rates`
- **Цена одинакова** в CarCard и CarDetailModal (используются данные из search_car)
- **Отображение в UI**: основная цена в рублях (крупно), эквивалент в валюте (мелко)

### Реализация:
- Функция `calculateFullPrice()` в `lib/currency.js`
- Функция `formatPriceBreakdown()` для отображения детализации

## Перевод цветов автомобилей

### Справочники:
- `color_translations.json` - китайский → английский (справочный)
- `lib/colorTranslations.js` - английский → русский (используется в коде)

### Процесс:
1. API get_car_info возвращает `colorname` на английском (например: "red", "pearl-white")
2. Функция `translateColor()` переводит на русский (например: "Красный", "Жемчужно-белый")
3. Если перевод не найден - возвращается оригинальное значение с заглавной буквы

### Поддерживаемые цвета:
42 цвета включая базовые (красный, белый, черный) и специальные (жемчужно-белый, сапфирово-синий, титаново-серебристый)

## Маппинг типов топлива

### Упрощенный маппинг (для карточек поиска):
Функция `apiFuelTypeToCategory()` используется в CarCard.jsx
```
Бензин:
  - Gasoline
  - Gasoline+CNG

Дизель:
  - Diesel Fuel

Гибрид: (все типы гибридов)
  - Gas-Electric Hybrid
  - Gasoline Electric Drive
  - Plug-In Hybrid
  - Extended Range
  - Diesel+48v Light Hybrid System
  - Gasoline + 48v Mild Hybrid System
  - Gasoline +90v Mild Hybrid System

Электричество:
  - Pure Electric
```

### Детальный маппинг (для модального окна):
Функция `apiFuelTypeToDetailedCategory()` используется в CarDetailModal.jsx
```
Параллельный гибрид:
  - Gas-Electric Hybrid
  - Gasoline Electric Drive
  - Plug-In Hybrid

Последовательный гибрид:
  - Extended Range

Мягкий гибрид (48V/90V системы):
  - Diesel+48v Light Hybrid System
  - Gasoline + 48v Mild Hybrid System
  - Gasoline +90v Mild Hybrid System

Бензин, Дизель, Электричество - без изменений
```

### Логика разделения:
- **В карточках поиска**: все гибриды отображаются как "Гибрид"
- **В модальном окне**: гибриды разделяются на 3 категории для более точной информации
- **При фильтрации**: используется упрощенный маппинг (один фильтр "Гибрид")

## Примечания
- Рабочая среда разработки: Windows, PowerShell 5.1
- API документация сохранена в api_specification.json
- Разработка: Vite proxy для обхода CORS
- Production: Nginx proxy к API в Docker контейнере
- ⚠️ Цены рассчитываются НА КЛИЕНТЕ по формуле компании (не используется total_price_rub из API)
- ⚠️ Токен API хранится в `frontend/src/lib/api.js` (виден в коде!)
- GitHub репозиторий: https://github.com/pit-ne-spit/avtozakaz74Site
- Активные ветки: main, presets-feature
